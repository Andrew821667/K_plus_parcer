#!/usr/bin/env python3
"""
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ—Å—Ç–æ–≤—ã—Ö PDF –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞

–°–æ–∑–¥–∞—ë—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö PDF –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ù–ü–ê
–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –ø–∞—Ä—Å–µ—Ä–∞
"""

from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.units import cm
from pathlib import Path


def create_test_npa_pdf(output_path: str, doc_info: dict):
    """
    –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π PDF –¥–æ–∫—É–º–µ–Ω—Ç –ù–ü–ê

    Args:
        output_path: –ü—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è PDF
        doc_info: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ (—Ç–∏–ø, –Ω–æ–º–µ—Ä, –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç.–¥.)
    """
    c = canvas.Canvas(output_path, pagesize=A4)
    width, height = A4

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à—Ä–∏—Ñ—Ç–∞
    try:
        # –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π —à—Ä–∏—Ñ—Ç
        c.setFont("Helvetica", 12)
    except:
        c.setFont("Helvetica", 12)

    y = height - 3*cm

    # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    c.setFont("Helvetica-Bold", 14)
    c.drawCentredString(width/2, y, doc_info['doc_type'])
    y -= 1*cm

    c.setFont("Helvetica", 12)
    c.drawCentredString(width/2, y, f"–æ—Ç {doc_info['date']} N {doc_info['number']}")
    y -= 1.5*cm

    c.setFont("Helvetica-Bold", 12)
    c.drawCentredString(width/2, y, doc_info['title'])
    y -= 1.5*cm

    # –ü—Ä–µ–∞–º–±—É–ª–∞
    if 'preamble' in doc_info:
        c.setFont("Helvetica", 10)
        lines = doc_info['preamble'].split('\n')
        for line in lines:
            if y < 2*cm:
                c.showPage()
                y = height - 2*cm
                c.setFont("Helvetica", 10)
            c.drawString(2*cm, y, line)
            y -= 0.5*cm
        y -= 0.5*cm

    # –ì–ª–∞–≤—ã –∏ —Å—Ç–∞—Ç—å–∏
    for chapter in doc_info.get('chapters', []):
        # –ì–ª–∞–≤–∞
        if y < 3*cm:
            c.showPage()
            y = height - 2*cm

        c.setFont("Helvetica-Bold", 11)
        c.drawString(2*cm, y, f"–ì–ª–∞–≤–∞ {chapter['number']}. {chapter['title']}")
        y -= 1*cm

        # –°—Ç–∞—Ç—å–∏ –≥–ª–∞–≤—ã
        for article in chapter.get('articles', []):
            if y < 4*cm:
                c.showPage()
                y = height - 2*cm
                c.setFont("Helvetica", 10)

            c.setFont("Helvetica-Bold", 10)
            c.drawString(2*cm, y, f"–°—Ç–∞—Ç—å—è {article['number']}. {article['title']}")
            y -= 0.7*cm

            # –ß–∞—Å—Ç–∏ —Å—Ç–∞—Ç—å–∏
            c.setFont("Helvetica", 10)
            for i, part in enumerate(article.get('parts', []), 1):
                if y < 2*cm:
                    c.showPage()
                    y = height - 2*cm
                    c.setFont("Helvetica", 10)

                # –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–∏
                part_lines = []
                words = part.split()
                current_line = f"{i}. "
                for word in words:
                    test_line = current_line + word + " "
                    if c.stringWidth(test_line, "Helvetica", 10) < (width - 4*cm):
                        current_line = test_line
                    else:
                        part_lines.append(current_line)
                        current_line = "   " + word + " "
                if current_line.strip():
                    part_lines.append(current_line)

                for line in part_lines:
                    if y < 1.5*cm:
                        c.showPage()
                        y = height - 2*cm
                        c.setFont("Helvetica", 10)
                    c.drawString(2.5*cm, y, line)
                    y -= 0.5*cm

                y -= 0.2*cm

            y -= 0.3*cm

    c.save()
    print(f"‚úÖ –°–æ–∑–¥–∞–Ω: {output_path}")


def main():
    """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö PDF –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"""
    output_dir = Path("data/input/codex")
    output_dir.mkdir(parents=True, exist_ok=True)

    print("üîß –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö PDF –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ù–ü–ê\n")

    # –¢–µ—Å—Ç 1: –ö–æ—Ä–æ—Ç–∫–∏–π –∑–∞–∫–æ–Ω
    test_doc_1 = {
        'doc_type': '–§–ï–î–ï–†–ê–õ–¨–ù–´–ô –ó–ê–ö–û–ù',
        'number': '1-–§–ó',
        'date': '1 —è–Ω–≤–∞—Ä—è 2020 –≥.',
        'title': '–û —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–∞—Ä—Å–µ—Ä–∞ –ù–ü–ê',
        'preamble': '–ü—Ä–∏–Ω—è—Ç –ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –î—É–º–æ–π 20 –¥–µ–∫–∞–±—Ä—è 2019 –≥–æ–¥–∞\n–û–¥–æ–±—Ä–µ–Ω –°–æ–≤–µ—Ç–æ–º –§–µ–¥–µ—Ä–∞—Ü–∏–∏ 25 –¥–µ–∫–∞–±—Ä—è 2019 –≥–æ–¥–∞',
        'chapters': [
            {
                'number': 1,
                'title': '–û–ë–©–ò–ï –ü–û–õ–û–ñ–ï–ù–ò–Ø',
                'articles': [
                    {
                        'number': '1',
                        'title': '–ü—Ä–µ–¥–º–µ—Ç —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–∞',
                        'parts': [
                            '–ù–∞—Å—Ç–æ—è—â–∏–π –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –∑–∞–∫–æ–Ω —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–æ–≤—ã–µ –æ—Å–Ω–æ–≤—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä—Å–µ—Ä–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ-–ø—Ä–∞–≤–æ–≤—ã—Ö –∞–∫—Ç–æ–≤.',
                            '–¶–µ–ª—è–º–∏ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–∞ —è–≤–ª—è—é—Ç—Å—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã –ø–∞—Ä—Å–µ—Ä–æ–≤.'
                        ]
                    },
                    {
                        'number': '2',
                        'title': '–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è',
                        'parts': [
                            '–î–ª—è —Ü–µ–ª–µ–π –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –§–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è: –ø–∞—Ä—Å–µ—Ä - –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.',
                            '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º.',
                            '–ù–æ—Ä–º–∞—Ç–∏–≤–Ω–æ-–ø—Ä–∞–≤–æ–≤–æ–π –∞–∫—Ç - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç, –ø—Ä–∏–Ω—è—Ç—ã–π —É–ø–æ–ª–Ω–æ–º–æ—á–µ–Ω–Ω—ã–º –æ—Ä–≥–∞–Ω–æ–º –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–ª–∞—Å—Ç–∏.'
                        ]
                    }
                ]
            },
            {
                'number': 2,
                'title': '–ü–û–†–Ø–î–û–ö –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø',
                'articles': [
                    {
                        'number': '3',
                        'title': '–ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',
                        'parts': [
                            '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ø—É—Ç–µ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.',
                            '–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –æ—à–∏–±–æ–∫ –≤ —Ä–∞–±–æ—Ç–µ –ø–∞—Ä—Å–µ—Ä–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.'
                        ]
                    }
                ]
            }
        ]
    }

    create_test_npa_pdf(str(output_dir / "TEST_–∑–∞–∫–æ–Ω_1_–§–ó.pdf"), test_doc_1)

    # –¢–µ—Å—Ç 2: –ü–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
    test_doc_2 = {
        'doc_type': '–ü–û–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ü–†–ê–í–ò–¢–ï–õ–¨–°–¢–í–ê –†–û–°–°–ò–ô–°–ö–û–ô –§–ï–î–ï–†–ê–¶–ò–ò',
        'number': '100',
        'date': '15 –º–∞—Ä—Ç–∞ 2021 –≥.',
        'title': '–û–± —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ü—Ä–∞–≤–∏–ª —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',
        'chapters': [
            {
                'number': 1,
                'title': '–û–ë–©–ò–ï –ü–û–õ–û–ñ–ï–ù–ò–Ø',
                'articles': [
                    {
                        'number': '1',
                        'title': '–û–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è',
                        'parts': [
                            '–ù–∞—Å—Ç–æ—è—â–∏–µ –ü—Ä–∞–≤–∏–ª–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤–Ω–æ-–ø—Ä–∞–≤–æ–≤—ã—Ö –∞–∫—Ç–æ–≤.'
                        ]
                    }
                ]
            }
        ]
    }

    create_test_npa_pdf(str(output_dir / "TEST_–ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ_100.pdf"), test_doc_2)

    # –¢–µ—Å—Ç 3: –ü—Ä–∏–∫–∞–∑
    test_doc_3 = {
        'doc_type': '–ü–†–ò–ö–ê–ó',
        'number': '50–Ω',
        'date': '10 –º–∞—è 2022 –≥.',
        'title': '–û –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä—Å–µ—Ä–æ–≤',
        'chapters': [
            {
                'number': 1,
                'title': '–ü–û–†–Ø–î–û–ö –ü–†–û–í–ï–†–ö–ò',
                'articles': [
                    {
                        'number': '1',
                        'title': '–≠—Ç–∞–ø—ã –ø—Ä–æ–≤–µ—Ä–∫–∏',
                        'parts': [
                            '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞ –≤–∫–ª—é—á–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∑–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞, –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.',
                            '–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç—á–µ—Ç –æ –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞—Ö –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö –ø–æ –∏—Ö —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é.'
                        ]
                    }
                ]
            }
        ]
    }

    create_test_npa_pdf(str(output_dir / "TEST_–ø—Ä–∏–∫–∞–∑_50–Ω.pdf"), test_doc_3)

    print(f"\n‚úÖ –°–æ–∑–¥–∞–Ω–æ {3} —Ç–µ—Å—Ç–æ–≤—ã—Ö PDF —Ñ–∞–π–ª–æ–≤ –≤: {output_dir}")
    print("\n–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å:")
    print("  python pipeline_codex.py")


if __name__ == "__main__":
    try:
        main()
    except ImportError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ reportlab")
        print("   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install reportlab")
        import sys
        sys.exit(1)
